---
- name: Bootstrap the environment -- install dependencies and set hostname.
  become: yes
  gather_facts: yes
  hosts: all
  tags: dependencies
  vars_files:
    - host_vars/main.yml
  roles:
    - base

# Create ssh users and revoke old root and default user access
# from a newly-provisioned machine.
#
# DANGER -- this is destructive. Make sure you want to totally bootstrap
# a new ssh environment.
- name: Create SSH users.
  become: yes
  hosts: all
  tags: ssh
  roles:
    - ssh-users

- name: Remove root access & harden box security.
  become: yes
  hosts: all
  tags: opsec
  roles:
    - opsec

- name: Set up NTP.
  become: yes
  hosts: all
  roles:
    - bennojoy.ntp

- name: Install docker.
  become: yes
  hosts: all
  tags: docker
  roles:
    - geerlingguy.docker

- name: Install pip.
  become: yes
  hosts: all
  tags: pip
  tasks:
    - include_role: name=geerlingguy.pip
    - pip: name=pip state=latest

# - name: Upgrade pip.
#   become: yes
#   hosts: all
#   tags: pip
#   tasks:
#     - pip: name=pip state=latest

- name: Determine if tmux is installed and up-to-date.
  hosts: all
  become: yes
  vars_files:
    - 'host_vars/main.yml'
  tags:
    - deps
    - tmux
  tasks:
    - name: Determine tmux version, if installed.
      shell: tmux -V | sed 's/tmux //'
      register: tmux_version
      ignore_errors: yes
    - name: Install tmux.
      include_role:
        name: tmux

# - name: Install tmux.
#   become: yes
#   hosts: all
#   vars_files:
#     - 'host_vars/main.yml'
#   tags:
#     - deps
#     - tmux
#   roles:
#     - tmux
#   when: not (tmux_version == '2.6')

- name: Install zsh and prezto.
  hosts: all
  become: yes
  tags:
    - deps
    - zsh
  vars_files:
    - 'host_vars/main.yml'
  tasks:
    - name: Install zsh.
      become: yes
      yum: name=zsh state=latest
    - name: Install Prezto.
      become: yes
      become_user: "{{ user }}"
      git:
        repo: https://github.com/sorin-ionescu/prezto
        dest: "$HOME/.zprezto"
        recursive: yes
        force: yes
    - name: Set default shell.
      become: yes
      user:
        name: "{{ user }}"
        shell: /bin/zsh

- name: Make yourself at home.
  gather_facts: yes
  hosts: all
  become: yes
  vars_files:
    - 'host_vars/main.yml'
  tags: homemaker
  roles:
    - homemaker

- name: Install Go.
  become: yes
  hosts: all
  tags:
    - deps
    - go
  roles:
    - joshualund.golang
